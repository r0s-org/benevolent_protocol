#!/usr/bin/env python3
"""
Malware Scanner Test Suite
Tests malware detection and removal functionality
"""

import sys
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from src.protection.malware_scanner import MalwareScanner, ThreatLevel, ThreatType
from src.protection.malware_remover import MalwareRemover


def test_malware_scanner():
    """Test malware scanning"""
    print("=" * 60)
    print("ü¶† MALWARE SCANNER TEST")
    print("=" * 60)
    print()

    scanner = MalwareScanner()

    print(f"Platform: {scanner.platform.upper()}\n")

    print("üîç Running quick scan...\n")

    threats = scanner.scan_system(quick_scan=True)

    print(f"\nüìä Scan Results:")
    print(f"   Total Threats: {len(threats)}\n")

    if threats:
        # Group by severity
        by_severity = {}
        for threat in threats:
            sev = threat.threat_level.value
            if sev not in by_severity:
                by_severity[sev] = []
            by_severity[sev].append(threat)

        # Display by severity
        for severity in ["critical", "high", "medium", "low", "info"]:
            if severity in by_severity:
                print(f"{severity.upper()} ({len(by_severity[severity])}):")
                for threat in by_severity[severity]:
                    print(f"   ‚Ä¢ {threat.name} ({threat.threat_type.value})")
                    print(f"     {threat.description}")
                    if threat.file_path:
                        print(f"     File: {threat.file_path}")
                    if threat.process_name:
                        print(f"     Process: {threat.process_name}")
                    print()
    else:
        print("   ‚úÖ No threats detected\n")

    return threats


def test_malware_remover(threats):
    """Test malware removal"""
    print("=" * 60)
    print("üóëÔ∏è MALWARE REMOVER TEST")
    print("=" * 60)
    print()

    if not threats:
        print("‚ö†Ô∏è  No threats to remove\n")
        return

    remover = MalwareRemover()

    print(f"Attempting to remove {len(threats)} threats...\n")

    results = remover.remove_threats(threats)

    # Count results
    successful = [r for r in results if r.success]
    failed = [r for r in results if not r.success]

    print(f"üìä Removal Results:")
    print(f"   Total: {len(results)}")
    print(f"   ‚úÖ Successful: {len(successful)}")
    print(f"   ‚ùå Failed: {len(failed)}\n")

    if successful:
        print("‚úÖ Successfully Removed:")
        for result in successful:
            print(f"   ‚Ä¢ {result.threat_name}")
            print(f"     {result.message}")
            if result.backup_path:
                print(f"     Quarantined: {result.backup_path}")
            print()

    if failed:
        print("‚ùå Failed to Remove:")
        for result in failed:
            print(f"   ‚Ä¢ {result.threat_name}")
            print(f"     Reason: {result.message}")
            print()


def test_threat_types():
    """Display malware threat types"""
    print("=" * 60)
    print("üìÅ MALWARE THREAT TYPES")
    print("=" * 60)
    print()

    threat_types = {
        "VIRUS": {
            "description": "Self-replicating malware",
            "severity": "HIGH to CRITICAL",
            "examples": ["File infectors", "Macro viruses", "Boot viruses"]
        },
        "TROJAN": {
            "description": "Disguised malicious software",
            "severity": "HIGH",
            "examples": ["Backdoors", "Downloaders", "Droppers"]
        },
        "WORM": {
            "description": "Self-propagating malware",
            "severity": "HIGH to CRITICAL",
            "examples": ["Email worms", "Network worms", "Internet worms"]
        },
        "RANSOMWARE": {
            "description": "Encrypts files for ransom",
            "severity": "CRITICAL",
            "examples": ["Crypto ransomware", "Locker ransomware", "Doxware"]
        },
        "SPYWARE": {
            "description": "Collects user information",
            "severity": "HIGH",
            "examples": ["Keyloggers", "Screen scrapers", "Information stealers"]
        },
        "ADWARE": {
            "description": "Displays unwanted advertisements",
            "severity": "LOW to MEDIUM",
            "examples": ["Pop-up generators", "Browser hijackers", "Ad injectors"]
        },
        "ROOTKIT": {
            "description": "Hides malicious activity",
            "severity": "CRITICAL",
            "examples": ["Kernel rootkits", "Bootkits", "User-mode rootkits"]
        },
        "CRYPTOMINER": {
            "description": "Uses system resources for mining",
            "severity": "MEDIUM to HIGH",
            "examples": ["XMRig", "CoinHive", "Browser miners"]
        },
        "BACKDOOR": {
            "description": "Provides remote access",
            "severity": "CRITICAL",
            "examples": ["Remote access trojans", "Reverse shells", "Web shells"]
        },
        "PUP": {
            "description": "Potentially unwanted programs",
            "severity": "LOW",
            "examples": ["Toolbars", "Cleaners", "Fake optimizers"]
        }
    }

    for threat_type, info in threat_types.items():
        print(f"ü¶† {threat_type}")
        print(f"   {info['description']}")
        print(f"   Severity: {info['severity']}")
        print(f"   Examples:")
        for example in info['examples']:
            print(f"     ‚Ä¢ {example}")
        print()


def test_detection_methods():
    """Display malware detection methods"""
    print("=" * 60)
    print("üîç MALWARE DETECTION METHODS")
    print("=" * 60)
    print()

    methods = {
        "SIGNATURE-BASED": {
            "description": "Matches known malware patterns",
            "pros": ["Fast", "Low false positives", "Accurate"],
            "cons": ["Cannot detect zero-day", "Requires signature database"],
            "effectiveness": "90% for known malware"
        },
        "BEHAVIOR-BASED": {
            "description": "Analyzes program behavior",
            "pros": ["Detects zero-day", "No signature needed"],
            "cons": ["Higher false positives", "Resource intensive"],
            "effectiveness": "70% for unknown malware"
        },
        "HEURISTIC": {
            "description": "Uses rules to identify suspicious code",
            "pros": ["Detects variants", "Proactive detection"],
            "cons": ["False positives", "Can be bypassed"],
            "effectiveness": "80% for variants"
        },
        "PROCESS SCANNING": {
            "description": "Scans running processes",
            "pros": ["Detects active malware", "Real-time"],
            "cons": ["Can miss dormant malware", "Process name spoofing"],
            "effectiveness": "85% for active infections"
        },
        "FILE SCANNING": {
            "description": "Scans file system",
            "pros": ["Comprehensive", "Finds dormant malware"],
            "cons": ["Slow", "Resource intensive"],
            "effectiveness": "95% with full scan"
        }
    }

    for method, info in methods.items():
        print(f"üî¨ {method}")
        print(f"   {info['description']}")
        print(f"   Effectiveness: {info['effectiveness']}")
        print(f"   Pros:")
        for pro in info['pros']:
            print(f"     ‚úÖ {pro}")
        print(f"   Cons:")
        for con in info['cons']:
            print(f"     ‚ùå {con}")
        print()


def test_quarantine_system():
    """Display quarantine system information"""
    print("=" * 60)
    print("üì¶ QUARANTINE SYSTEM")
    print("=" * 60)
    print()

    print("HOW IT WORKS:")
    print("   1. Malicious file detected")
    print("   2. File moved to quarantine directory")
    print("   3. Permissions removed (non-executable)")
    print("   4. Original location cleaned")
    print("   5. Removal logged")
    print()

    print("QUARANTINE DIRECTORY:")
    print("   /tmp/benevolent_protocol_quarantine/")
    print()

    print("FILE NAMING:")
    print("   <original_name>.<timestamp>.quarantine")
    print("   Example: malware.exe.1734567890.quarantine")
    print()

    print("RESTORATION:")
    print("   Files can be restored if removal was false positive")
    print("   Use restore_from_quarantine() method")
    print()

    print("LOGGING:")
    print("   All removals logged to quarantine_dir/removal_log.txt")
    print("   Includes timestamp, threat info, file paths")
    print()


def test_safety_features():
    """Display malware removal safety features"""
    print("=" * 60)
    print("üõ°Ô∏è MALWARE REMOVAL SAFETY FEATURES")
    print("=" * 60)
    print()

    print("‚úÖ QUARANTINE BEFORE REMOVAL:")
    print("   ‚Ä¢ All files quarantined before deletion")
    print("   ‚Ä¢ Original file preserved")
    print("   ‚Ä¢ Can restore if needed")
    print()

    print("‚úÖ LOGGING:")
    print("   ‚Ä¢ All removals logged")
    print("   ‚Ä¢ Timestamp and details recorded")
    print("   ‚Ä¢ Audit trail maintained")
    print()

    print("‚úÖ PERMISSION REMOVAL:")
    print("   ‚Ä¢ Quarantined files made non-executable")
    print("   ‚Ä¢ Prevents accidental execution")
    print("   ‚Ä¢ chmod 000 applied")
    print()

    print("‚ö†Ô∏è MANUAL INTERVENTION:")
    print("   ‚Ä¢ Some threats require expert analysis")
    print("   ‚Ä¢ Ransomware: Disconnect network immediately")
    print("   ‚Ä¢ Rootkits: Consider full system reinstall")
    print("   ‚Ä¢ Backdoors: Change all passwords")
    print()

    print("üîÑ RESTORATION:")
    print("   ‚Ä¢ Files can be restored from quarantine")
    print("   ‚Ä¢ Original permissions restored")
    print("   ‚Ä¢ Useful for false positives")
    print()


def test_threat_levels():
    """Display threat severity levels"""
    print("=" * 60)
    print("üìä THREAT SEVERITY LEVELS")
    print("=" * 60)
    print()

    levels = {
        "CRITICAL": {
            "color": "üî¥",
            "description": "Immediate danger, active malware",
            "examples": ["Ransomware encrypting files", "Rootkit active", "Backdoor open"],
            "action": "Immediate removal or manual intervention",
            "restart": "Likely required"
        },
        "HIGH": {
            "color": "üü†",
            "description": "Significant risk, malware detected",
            "examples": ["Trojan active", "Spyware collecting data", "Cryptominer running"],
            "action": "Remove immediately",
            "restart": "May be required"
        },
        "MEDIUM": {
            "color": "üü°",
            "description": "Moderate risk, suspicious activity",
            "examples": ["Suspicious scripts", "Unusual network activity", "PUPs"],
            "action": "Review and remove",
            "restart": "Usually not required"
        },
        "LOW": {
            "color": "üîµ",
            "description": "Minor concern, low impact",
            "examples": ["Adware", "Toolbars", "Fake cleaners"],
            "action": "Remove if unwanted",
            "restart": "Not required"
        },
        "INFO": {
            "color": "‚ö™",
            "description": "Informational, no immediate threat",
            "examples": ["Outdated software", "Weak configurations"],
            "action": "Review and address",
            "restart": "Not required"
        }
    }

    for level, info in levels.items():
        print(f"{info['color']} {level}")
        print(f"   {info['description']}")
        print(f"   Examples:")
        for example in info['examples']:
            print(f"     ‚Ä¢ {example}")
        print(f"   Action: {info['action']}")
        print(f"   Restart: {info['restart']}")
        print()


def main():
    """Run all malware tests"""
    print()
    print("=" * 60)
    print("ü¶† MALWARE SCANNER TEST SUITE")
    print("=" * 60)
    print()

    # Display threat types
    test_threat_types()
    print()

    # Display detection methods
    test_detection_methods()
    print()

    # Display threat levels
    test_threat_levels()
    print()

    # Display quarantine system
    test_quarantine_system()
    print()

    # Display safety features
    test_safety_features()
    print()

    # Run actual scan
    print("=" * 60)
    print("üîç ACTUAL SYSTEM SCAN")
    print("=" * 60)
    print()

    threats = test_malware_scanner()

    # Test removal
    print()
    print("=" * 60)
    print("üóëÔ∏è ACTUAL REMOVAL TEST")
    print("=" * 60)
    print()

    test_malware_remover(threats)

    print()
    print("=" * 60)
    print("‚úÖ MALWARE TEST SUITE COMPLETE")
    print("=" * 60)
    print()


if __name__ == "__main__":
    main()
